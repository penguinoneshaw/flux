apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: woodpecker-ci
  namespace: woodpecker
spec:
  releaseName: woodpecker
  chart:
    spec:
      chart: woodpecker
      reconcileStrategy: ChartVersion
      version: 1.5.1
      sourceRef:
        kind: HelmRepository
        name: woodpecker
        namespace: woodpecker
  interval: 30m
  valuesFrom:
    - kind: ConfigMap
      name: woodpecker-values
  upgrade:
    force: true
    crds: CreateReplace
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: woodpecker
  namespace: woodpecker
spec:
  endpoints:
    - interval: 30s
      port: http
      scheme: http
      bearerTokenSecret:
        key: password
        name: woodpecker-prometheus-token
  selector:
    matchLabels:
      app.kubernetes.io/instance: woodpecker
      app.kubernetes.io/name: server
